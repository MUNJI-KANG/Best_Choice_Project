{% extends 'manager/manager_base.html' %}
{% load static %}

{% block title %}AI ë¶„ì„ ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block extra_css %}
<style>
    .ai-dashboard-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    /* íƒ­ ìŠ¤íƒ€ì¼ */
    .tab-container {
        margin-bottom: 24px;
    }
    
    .tab-buttons {
        display: flex;
        gap: 8px;
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 24px;
    }
    
    .tab-button {
        padding: 12px 24px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.2s;
    }
    
    .tab-button:hover {
        color: #3b82f6;
    }
    
    .tab-button.active {
        color: #22c55e;
        position: relative;
    }
    
    .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
        border-radius: 2px;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* í•„í„° ì¹´ë“œ */
    .filter-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 24px;
    }
    
    /* ë¶„ì„ íƒ­ ìŠ¤íƒ€ì¼ */
    .insights-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 24px;
    }
    
    .insights-header {
        background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
        color: white;
        padding: 20px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .insights-body {
        padding: 32px;
        background: #f8f9fa;
        min-height: 400px;
    }
    
    .ai-insights-content {
        font-size: 16px;
        line-height: 1.8;
        color: #2c3e50;
    }
    
    .ai-insights-content h2 {
        background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 24px;
        margin-top: 32px;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .ai-insights-content h3 {
        color: #16a34a;
        font-size: 20px;
        margin-top: 24px;
        margin-bottom: 12px;
    }
    
    .ai-insights-content h4 {
        color: #495057;
        font-size: 18px;
        margin-top: 20px;
        margin-bottom: 10px;
    }
    
    .ai-insights-content p {
        margin-bottom: 16px;
    }
    
    .ai-insights-content ul, .ai-insights-content ol {
        margin-bottom: 16px;
        padding-left: 24px;
    }
    
    .ai-insights-content li {
        margin-bottom: 8px;
    }
    
    .ai-insights-content strong {
        background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 600;
    }
    
    .ai-insights-content code {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .ai-insights-content blockquote {
        border-left: 4px solid #3b82f6;
        padding-left: 16px;
        margin-left: 0;
        color: #6c757d;
        font-style: italic;
        position: relative;
    }
    
    .ai-insights-content blockquote::before {
        content: '';
        position: absolute;
        left: -4px;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
    }
    
    /* ì±„íŒ… íƒ­ ìŠ¤íƒ€ì¼ */
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 300px);
        min-height: 600px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
        color: white;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat-header-actions {
        display: flex;
        gap: 12px;
    }
    
    .chat-header-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
    }
    
    .chat-header-btn:hover {
        background: rgba(255,255,255,0.3);
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        background: #f8f9fa;
    }
    
    .message {
        display: flex;
        margin-bottom: 24px;
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message.assistant {
        justify-content: flex-start;
    }
    
    .message-content {
        max-width: 70%;
        padding: 16px 20px;
        border-radius: 18px;
        line-height: 1.6;
    }
    
    .message.user .message-content {
        background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message.assistant .message-content {
        background: white;
        color: #2c3e50;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .message.assistant .message-content h1,
    .message.assistant .message-content h2,
    .message.assistant .message-content h3 {
        background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-top: 16px;
        margin-bottom: 8px;
    }
    
    .message.assistant .message-content h1:first-child,
    .message.assistant .message-content h2:first-child,
    .message.assistant .message-content h3:first-child {
        margin-top: 0;
    }
    
    .message.assistant .message-content code {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .message.assistant .message-content pre {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        overflow-x: auto;
    }
    
    .message.assistant .message-content ul,
    .message.assistant .message-content ol {
        margin: 12px 0;
        padding-left: 24px;
    }
    
    .message.assistant .message-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 16px 0;
        font-size: 14px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .message.assistant .message-content table thead {
        background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
        color: white;
    }
    
    .message.assistant .message-content table th {
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid rgba(255,255,255,0.2);
    }
    
    .message.assistant .message-content table tbody tr {
        background: white;
        border-bottom: 1px solid #e9ecef;
    }
    
    .message.assistant .message-content table tbody tr:nth-child(even) {
        background: #f8f9fa;
    }
    
    .message.assistant .message-content table tbody tr:hover {
        background: #e9ecef;
    }
    
    .message.assistant .message-content table td {
        padding: 10px 16px;
        border-right: 1px solid #e9ecef;
    }
    
    .message.assistant .message-content table td:last-child {
        border-right: none;
    }
    
    .chat-input-container {
        padding: 20px 24px;
        background: white;
        border-top: 1px solid #e9ecef;
    }
    
    .quick-questions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
    }
    
    .quick-question-btn {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        color: #495057;
        transition: all 0.2s;
    }
    
    .quick-question-btn:hover {
        background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
        color: white;
        border-color: transparent;
    }
    
    .chat-input-wrapper {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }
    
    .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 24px;
        font-size: 15px;
        resize: none;
        max-height: 120px;
        font-family: inherit;
    }
    
    .chat-input:focus {
        outline: none;
        border: 2px solid #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .chat-send-btn {
        background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 24px;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .chat-send-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .chat-send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .typing-indicator {
        display: none;
        padding: 16px 20px;
        background: white;
        border-radius: 18px;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .typing-indicator.active {
        display: block;
    }
    
    .typing-dots {
        display: inline-block;
    }
    
    .typing-dots span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
        margin: 0 2px;
        animation: typing 1.4s infinite;
    }
    
    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }
    
    .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 24px;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        margin: 0;
    }
    
    .stat-value.primary { color: #007bff; }
    .stat-value.success { color: #28a745; }
    .stat-value.danger { color: #dc3545; }
    .stat-value.warning { color: #ffc107; }
    
    .loading-spinner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-right: 4px solid #22c55e;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    
    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    
    .btn-refresh {
        background: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        width: auto;
        min-width: 150px;
        white-space: nowrap;
    }
    
    .btn-refresh:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .form-control {
        padding: 10px 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s;
    }
    
    .form-control:focus {
        outline: none;
        border: 2px solid #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .alert-danger {
        background: #fff5f5;
        border: 1px solid #fed7d7;
        color: #c53030;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="ai-dashboard-container">
    <div style="text-align: center; margin-bottom: 32px;">
        <h1 style="font-size: 32px; font-weight: 700; color: #2c3e50; margin-bottom: 8px;">
            ğŸ¤– AI ë¶„ì„ ëŒ€ì‹œë³´ë“œ
        </h1>
        <p style="color: #6c757d; font-size: 16px;">ë°ì´í„° ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ë¡œ ë” ë‚˜ì€ ì˜ì‚¬ê²°ì •ì„ ì§€ì›í•©ë‹ˆë‹¤</p>
    </div>

    <!-- íƒ­ ì»¨í…Œì´ë„ˆ -->
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('analysis')">ğŸ“Š ìë™ ë¶„ì„</button>
            <button class="tab-button" onclick="switchTab('chat')">ğŸ’¬ AI ì±„íŒ…</button>
        </div>

        <!-- í•„í„° ì„¹ì…˜ -->
        <div class="filter-card" id="filterCard">
            <form method="get" id="filterForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 20px; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">ê¸°ê°„ ì„ íƒ</label>
                        <select name="date_range" id="dateRange" class="form-control" onchange="document.getElementById('filterForm').submit()">
                            <option value="7" {% if date_range == '7' %}selected{% endif %}>ìµœê·¼ 7ì¼</option>
                            <option value="30" {% if date_range == '30' %}selected{% endif %}>ìµœê·¼ 30ì¼</option>
                            <option value="90" {% if date_range == '90' %}selected{% endif %}>ìµœê·¼ 90ì¼</option>
                        </select>
                    </div>
                    <div id="analysisTypeContainer">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">ë¶„ì„ ìœ í˜•</label>
                        <select name="analysis_type" class="form-control" onchange="document.getElementById('filterForm').submit()">
                            <option value="overview" {% if analysis_type == 'overview' %}selected{% endif %}>ğŸ“Š ì¢…í•© ë¶„ì„</option>
                            <option value="reservations" {% if analysis_type == 'reservations' %}selected{% endif %}>ğŸ“… ì˜ˆì•½ íŒ¨í„´ ë¶„ì„</option>
                            <option value="members" {% if analysis_type == 'members' %}selected{% endif %}>ğŸ‘¥ íšŒì› í–‰ë™ ë¶„ì„</option>
                            <option value="anomalies" {% if analysis_type == 'anomalies' %}selected{% endif %}>âš ï¸ ì´ìƒ íƒì§€</option>
                        </select>
                    </div>
                    <div style="display: flex; justify-content: flex-end;">
                        <button type="button" class="btn-refresh" onclick="refreshAnalysis()">
                            ğŸ” ë¶„ì„ ì‹œì‘
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- ë¶„ì„ íƒ­ -->
        <div id="analysisTab" class="tab-content active">
            <div class="insights-card">
                <div class="insights-header">
                    <h5>âœ¨ AI ë¶„ì„ ì¸ì‚¬ì´íŠ¸</h5>
                    <span style="font-size: 14px; opacity: 0.9;">ì‹¤ì‹œê°„ ë¶„ì„ ê²°ê³¼</span>
                </div>
                <div class="insights-body" id="insightsBody">
                    {% if error_message %}
                        <div class="alert-danger">
                            <strong>âš ï¸ ì˜¤ë¥˜ ë°œìƒ:</strong> {{ error_message }}
                            <br><br>
                            <small>í™˜ê²½ ë³€ìˆ˜ì— OPENAI_API_KEYê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</small>
                        </div>
                    {% elif ai_insights_html %}
                        <div class="ai-insights-content">
                            {{ ai_insights_html|safe }}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“Š</div>
                            <h3 style="color: #495057; margin-bottom: 12px;">ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”</h3>
                            <p style="color: #6c757d; font-size: 16px;">
                                ìœ„ì˜ í•„í„°ë¥¼ ì„ íƒí•˜ê³  'ë¶„ì„ ì‹œì‘' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬<br>
                                AI ê¸°ë°˜ ë°ì´í„° ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ì±„íŒ… íƒ­ -->
        <div id="chatTab" class="tab-content">
            <div class="chat-container">
                <div class="chat-header">
                    <div>
                        <h5 style="margin: 0; font-size: 18px;">ğŸ’¬ AI ë¶„ì„ê°€ì™€ ëŒ€í™”í•˜ê¸°</h5>
                        <small style="opacity: 0.9;">í†µê³„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì§ˆë¬¸í•˜ì„¸ìš”</small>
                    </div>
                    <div class="chat-header-actions" style="display: flex; gap: 8px; align-items: center;">
                        <button class="btn-refresh" onclick="clearChatHistory()" style="margin: 0;">ğŸ—‘ï¸ ëŒ€í™” ì´ˆê¸°í™”</button>
                        <button class="chat-header-btn" onclick="exportChat()">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="empty-state" id="chatEmptyState">
                        <div class="empty-state-icon">ğŸ’¬</div>
                        <h3 style="color: #495057; margin-bottom: 12px;">ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</h3>
                        <p style="color: #6c757d; font-size: 16px;">
                            ì•„ë˜ ì§ˆë¬¸ ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜ ì§ì ‘ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.
                        </p>
                    </div>
                </div>
                <div class="chat-input-container">
                    <div class="quick-questions">
                        <button class="quick-question-btn" onclick="sendQuickQuestion('ì´ë²ˆ ì£¼ ì˜ˆì•½ ì¶”ì´ëŠ” ì–´ë•Œ?')">ì´ë²ˆ ì£¼ ì˜ˆì•½ ì¶”ì´ëŠ” ì–´ë•Œ?</button>
                        <button class="quick-question-btn" onclick="sendQuickQuestion('ì·¨ì†Œìœ¨ì´ ë†’ì€ ìš”ì¼ì€?')">ì·¨ì†Œìœ¨ì´ ë†’ì€ ìš”ì¼ì€?</button>
                        <button class="quick-question-btn" onclick="sendQuickQuestion('ê°€ì¥ ì¸ê¸° ìˆëŠ” ì¢…ëª©ì€?')">ê°€ì¥ ì¸ê¸° ìˆëŠ” ì¢…ëª©ì€?</button>
                        <button class="quick-question-btn" onclick="sendQuickQuestion('íšŒì› ê°€ì… íŠ¸ë Œë“œë¥¼ ë¶„ì„í•´ì¤˜')">íšŒì› ê°€ì… íŠ¸ë Œë“œ ë¶„ì„</button>
                        <button class="quick-question-btn" onclick="sendQuickQuestion('ê°œì„ ì´ í•„ìš”í•œ ì˜ì—­ì€?')">ê°œì„ ì´ í•„ìš”í•œ ì˜ì—­ì€?</button>
                    </div>
                    <div class="chat-input-wrapper">
                        <textarea 
                            id="chatInput" 
                            class="chat-input" 
                            placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (Enterë¡œ ì „ì†¡, Shift+Enterë¡œ ì¤„ë°”ê¿ˆ)"
                            rows="1"
                            onkeydown="handleChatInputKey(event)"
                        ></textarea>
                        <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í†µê³„ ìš”ì•½ -->
    <div class="stats-summary">
        <div class="stat-card">
            <div class="stat-label">ì˜¤ëŠ˜ ì˜ˆì•½</div>
            <div class="stat-value primary">{{ stats_data.kpi_data.today_reservations|default:0 }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì˜¤ëŠ˜ ì‹ ê·œ íšŒì›</div>
            <div class="stat-value success">{{ stats_data.kpi_data.today_members|default:0 }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì·¨ì†Œìœ¨</div>
            <div class="stat-value danger">{{ stats_data.cancellation_rate|default:0 }}%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì˜¤ëŠ˜ ëª¨ì§‘ê¸€</div>
            <div class="stat-value warning">{{ stats_data.kpi_data.today_communities|default:0 }}</div>
        </div>
    </div>
</div>

<script>
const dateRange = '{{ date_range }}';
let isStreaming = false;

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function switchTab(tabName) {
    // íƒ­ ë²„íŠ¼ í™œì„±í™”
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    const filterCard = document.getElementById('filterCard');
    
    if (tabName === 'analysis') {
        document.querySelector('.tab-button').classList.add('active');
        document.getElementById('analysisTab').classList.add('active');
        document.getElementById('analysisTypeContainer').style.display = 'block';
        filterCard.style.display = 'block';  // ë¶„ì„ íƒ­ì—ì„œëŠ” í•„í„° ì¹´ë“œ í‘œì‹œ
    } else {
        document.querySelectorAll('.tab-button')[1].classList.add('active');
        document.getElementById('chatTab').classList.add('active');
        document.getElementById('analysisTypeContainer').style.display = 'none';
        filterCard.style.display = 'none';  // ì±„íŒ… íƒ­ì—ì„œëŠ” í•„í„° ì¹´ë“œ ìˆ¨ê¹€
        loadChatHistory();
    }
}

function refreshAnalysis() {
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    const insightsBody = document.getElementById('insightsBody');
    
    insightsBody.innerHTML = `
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p style="color: #6c757d; font-size: 16px; margin: 0;">AIê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            <p style="color: #adb5bd; font-size: 14px; margin-top: 8px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
        </div>
    `;
    
    fetch('{% url "ai_analytics:analyze_ajax" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            'date_range': formData.get('date_range'),
            'analysis_type': formData.get('analysis_type')
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.insights_html) {
                insightsBody.innerHTML = `<div class="ai-insights-content">${data.insights_html}</div>`;
            } else {
                insightsBody.innerHTML = `<div class="ai-insights-content" style="white-space: pre-wrap;">${data.insights}</div>`;
            }
        } else {
            insightsBody.innerHTML = `
                <div class="alert-danger">
                    <strong>âš ï¸ ì˜¤ë¥˜ ë°œìƒ:</strong> ${data.error}
                </div>
            `;
        }
    })
    .catch(error => {
        insightsBody.innerHTML = `
            <div class="alert-danger">
                <strong>âš ï¸ ìš”ì²­ ì˜¤ë¥˜:</strong> ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}
            </div>
        `;
    });
}

function addMessage(role, content, isHtml = false) {
    const chatMessages = document.getElementById('chatMessages');
    const emptyState = document.getElementById('chatEmptyState');
    
    if (emptyState) {
        emptyState.style.display = 'none';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (isHtml) {
        contentDiv.innerHTML = content;
    } else {
        contentDiv.textContent = content;
    }
    
    messageDiv.appendChild(contentDiv);
    chatMessages.appendChild(messageDiv);
    
    // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    return contentDiv;
}

function sendChatMessage(messageText = null) {
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('chatSendBtn');
    const message = messageText || chatInput.value.trim();
    
    if (!message || isStreaming) return;
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    addMessage('user', message);
    
    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    if (!messageText) {
        chatInput.value = '';
        chatInput.style.height = 'auto';
    }
    
    // ì „ì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”
    sendBtn.disabled = true;
    isStreaming = true;
    
    // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message assistant';
    typingDiv.innerHTML = `
        <div class="typing-indicator active">
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    document.getElementById('chatMessages').appendChild(typingDiv);
    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    
    // ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ë°›ê¸° (EventSource ì‚¬ìš©)
    const chatUrl = `{% url "ai_analytics:chat_ajax" %}?message=${encodeURIComponent(message)}&date_range=${dateRange}`;
    const eventSource = new EventSource(chatUrl);
    
    const responseDiv = document.createElement('div');
    responseDiv.className = 'message assistant';
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    responseDiv.appendChild(contentDiv);
    
    let fullResponse = '';
    let isFirstChunk = true;  // ì²« ë²ˆì§¸ chunkì¸ì§€ ì¶”ì 
    
    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            
            if (data.done) {
                eventSource.close();
                typingDiv.remove();
                // ì´ë¯¸ DOMì— ì¶”ê°€ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì¶”ê°€ ì‘ì—… ë¶ˆí•„ìš”
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
                sendBtn.disabled = false;
                isStreaming = false;
            } else if (data.chunk) {
                // ì²« ë²ˆì§¸ chunkê°€ ì˜¤ë©´ DOMì— ì¶”ê°€í•˜ê³  typingDiv ì œê±°
                if (isFirstChunk) {
                    typingDiv.remove();
                    document.getElementById('chatMessages').appendChild(responseDiv);
                    isFirstChunk = false;
                }
                
                fullResponse += data.chunk;
                // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
                contentDiv.innerHTML = markdownToHtml(fullResponse);
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            }
        } catch (e) {
            console.error('íŒŒì‹± ì˜¤ë¥˜:', e);
        }
    };
    
    eventSource.onerror = function(error) {
        eventSource.close();
        typingDiv.remove();
        sendBtn.disabled = false;
        isStreaming = false;
        addMessage('assistant', 'âš ï¸ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    };
}

function sendQuickQuestion(question) {
    document.getElementById('chatInput').value = question;
    sendChatMessage(question);
}

function handleChatInputKey(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
    }
    // ìë™ ë†’ì´ ì¡°ì ˆ
    const textarea = event.target;
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

// í…Œì´ë¸” ë³€í™˜ í•¨ìˆ˜
function convertTableToHtml(tableLines) {
    if (tableLines.length === 0) return '';
    
    let tableHtml = '<table><thead><tr>';
    
    // ì²« ë²ˆì§¸ ì¤„ì´ í—¤ë”
    const headerLine = tableLines[0];
    const headers = headerLine.split('|').map(h => h.trim()).filter(h => h);
    
    headers.forEach(h => {
        tableHtml += `<th>${h}</th>`;
    });
    tableHtml += '</tr></thead><tbody>';
    
    // ë‚˜ë¨¸ì§€ ì¤„ì´ ë°ì´í„° í–‰
    for (let i = 1; i < tableLines.length; i++) {
        const cells = tableLines[i].split('|').map(c => c.trim()).filter(c => c);
        if (cells.length > 0) {
            tableHtml += '<tr>';
            cells.forEach(cell => {
                tableHtml += `<td>${cell}</td>`;
            });
            tableHtml += '</tr>';
        }
    }
    
    tableHtml += '</tbody></table>';
    return tableHtml;
}

function markdownToHtml(text) {
    if (!text) return '';
    
    let html = text;
    
    // ì½”ë“œ ë¸”ë¡ ì²˜ë¦¬ (```ë¡œ ê°ì‹¼ ë¶€ë¶„) - ê°€ì¥ ë¨¼ì € ì²˜ë¦¬
    html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
    
    // í…Œì´ë¸” ì²˜ë¦¬ (ë¦¬ìŠ¤íŠ¸ë³´ë‹¤ ë¨¼ì € ì²˜ë¦¬)
    const lines = html.split('\n');
    let tableLines = [];
    let inTable = false;
    let result = [];
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // ì½”ë“œ ë¸”ë¡ ë‚´ë¶€ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
        if (line.includes('<pre><code>') || line.includes('</code></pre>')) {
            if (inTable && tableLines.length > 0) {
                result.push(convertTableToHtml(tableLines));
                tableLines = [];
                inTable = false;
            }
            result.push(line);
            continue;
        }
        
        // í…Œì´ë¸” í–‰ì¸ì§€ í™•ì¸ (|ë¡œ ì‹œì‘í•˜ê³  ëë‚˜ëŠ” ì¤„)
        const isTableRow = /^\|.+\|$/.test(line.trim());
        const isTableSeparator = /^\|[\s\-:]+\|$/.test(line.trim());
        
        if (isTableRow && !isTableSeparator) {
            if (!inTable) {
                inTable = true;
                tableLines = [];
            }
            tableLines.push(line);
        } else if (isTableSeparator && inTable) {
            // í—¤ë” êµ¬ë¶„ì„ ì€ ë¬´ì‹œ (ì´ë¯¸ í—¤ë”ê°€ ìˆìœ¼ë¯€ë¡œ)
            continue;
        } else {
            // í…Œì´ë¸”ì´ ëë‚¬ìœ¼ë©´ ë³€í™˜
            if (inTable && tableLines.length > 0) {
                result.push(convertTableToHtml(tableLines));
                tableLines = [];
                inTable = false;
            }
            result.push(line);
        }
    }
    
    // ë§ˆì§€ë§‰ í…Œì´ë¸” ì²˜ë¦¬
    if (inTable && tableLines.length > 0) {
        result.push(convertTableToHtml(tableLines));
    }
    
    html = result.join('\n');
    
    // ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬
    const listLines = html.split('\n');
    let inList = false;
    let listType = '';
    let listResult = [];
    
    for (let i = 0; i < listLines.length; i++) {
        const line = listLines[i];
        
        // ì½”ë“œ ë¸”ë¡, í…Œì´ë¸” íƒœê·¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
        if (line.includes('<pre><code>') || line.includes('</code></pre>') ||
            line.includes('<table>') || line.includes('</table>') ||
            line.includes('<thead>') || line.includes('</thead>') ||
            line.includes('<tbody>') || line.includes('</tbody>') ||
            line.includes('<tr>') || line.includes('</tr>') ||
            line.includes('<th>') || line.includes('</th>') ||
            line.includes('<td>') || line.includes('</td>')) {
            if (inList) {
                listResult.push(`</${listType}>`);
                inList = false;
                listType = '';
            }
            listResult.push(line);
            continue;
        }
        
        const bulletMatch = line.match(/^[\*\-] (.+)$/);
        const numberMatch = line.match(/^\d+\. (.+)$/);
        
        if (bulletMatch) {
            if (!inList || listType !== 'ul') {
                if (inList) listResult.push(`</${listType}>`);
                listResult.push('<ul>');
                inList = true;
                listType = 'ul';
            }
            listResult.push(`<li>${bulletMatch[1]}</li>`);
        } else if (numberMatch) {
            if (!inList || listType !== 'ol') {
                if (inList) listResult.push(`</${listType}>`);
                listResult.push('<ol>');
                inList = true;
                listType = 'ol';
            }
            listResult.push(`<li>${numberMatch[1]}</li>`);
        } else {
            if (inList) {
                listResult.push(`</${listType}>`);
                inList = false;
                listType = '';
            }
            listResult.push(line);
        }
    }
    
    if (inList) {
        listResult.push(`</${listType}>`);
    }
    
    html = listResult.join('\n');
    
    // ì¸ë¼ì¸ ì½”ë“œ ì²˜ë¦¬
    html = html.replace(/`([^`\n]+)`/g, '<code>$1</code>');
    
    // ê°•ì¡° ì²˜ë¦¬ (ìˆœì„œ ì¤‘ìš”: ** ë¨¼ì €, * ë‚˜ì¤‘)
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
    
    // í—¤ë” ì²˜ë¦¬
    html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
    
    // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
    html = html.replace(/\n(?!<[\/]?(ul|ol|li|h[1-6]|pre|code|p|br|strong|em|table|thead|tbody|tr|th|td))/g, '<br>');
    
    // ì—°ì†ëœ <br> ì •ë¦¬
    html = html.replace(/(<br>\s*){3,}/g, '<br><br>');
    
    return html;
}

function loadChatHistory() {
    // ëŒ€í™” íˆìŠ¤í† ë¦¬ëŠ” ì„œë²„ì—ì„œ ìë™ìœ¼ë¡œ ë¡œë“œë¨ (ì„¸ì…˜ ê¸°ë°˜)
    // í•„ìš”ì‹œ AJAXë¡œ íˆìŠ¤í† ë¦¬ ë¡œë“œ ê°€ëŠ¥
}

function clearChatHistory() {
    if (!confirm('ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    fetch('{% url "ai_analytics:chat_clear" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            'date_range': dateRange
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('chatMessages').innerHTML = `
                <div class="empty-state" id="chatEmptyState">
                    <div class="empty-state-icon">ğŸ’¬</div>
                    <h3 style="color: #495057; margin-bottom: 12px;">ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</h3>
                    <p style="color: #6c757d; font-size: 16px;">
                        ì•„ë˜ ì§ˆë¬¸ ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜ ì§ì ‘ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.
                    </p>
                </div>
            `;
        }
    });
}

function exportChat() {
    window.open(`{% url "ai_analytics:chat_export" %}?date_range=${dateRange}`, '_blank');
}
</script>
{% endblock %}
