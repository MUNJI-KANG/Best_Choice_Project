{% extends 'common/base.html' %}
{% load static %}
{% block css %}
<link rel="stylesheet" href="{% static 'recruitment/css/recruitment_list.css' %}" />
<link rel="stylesheet" href="{% static 'recruitment/css/recruitment_write.css' %}" />
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
{% endblock %}


{% block title %}
ëª¨ì§‘í• ë˜ - í• ë˜ë§ë˜
{% endblock %}

{% block script1 %}
<script>
    {% if mode == "edit" %}
        // ìˆ˜ì • ëª¨ë“œ â†’ ê¸°ì¡´ ë‚´ìš© ì£¼ì…
        window.initialContent = `{{ recruit.contents|escapejs }}`;
    {% else %}
        // ì‘ì„± ëª¨ë“œ â†’ ë¹ˆê°’
        window.initialContent = ``;
    {% endif %}
    
</script>
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<script src="{% static 'recruitment/js/recruitment_write.js' %}"></script>
<script src="{% static 'recruitment/js/recruitment_update.js' %}"></script>
<script src="{% static 'common/js/board/editor.js' %}"></script>
{% endblock %}

{% block contents %}


<!-- Hero ì„¹ì…˜ -->
<div class="board-hero recruitment-hero">
  {% if mode == 'create' %}
  <h2>ëª¨ì§‘í• ë˜ ì‘ì„±</h2>
  {% else %}
  <h2>ëª¨ì§‘í• ë˜ ìˆ˜ì •</h2>
  {% endif %}
</div>




<!-- ì„œë¸Œ ì»¨í…Œì´ë„ˆ -->
<div class="sub-container">
  <div class="sub-content">

    <!-- ì‘ì„± í¼ -->
    <form id="recruit-form"
          class="recruitmnent-write-form"
          method="POST"
          action="{% if mode == 'create' %}{% url 'recruitment:recruitment_write' %}
                {% else %}{% url 'recruitment:recruitment_update' recruit.community_id %}{% endif %}" 
          enctype="multipart/form-data">
      {% csrf_token %}

      <div class="form-wrapper">
        <!-- 1. ì œëª© -->
        <div class="form-group full-row">
          <label class="form-label">ì œëª©</label>
          <input type="text" class="form-input" name="title"
            value="{% if mode == 'edit' %}{{recruit.title}}{% endif %}"
            {% if mode == "edit" %} readonly {% endif %} 
            required>
        </div>

        <!-- 2. êµ¬ / ì¢…ëª© / ëª¨ì§‘ì¸ì› / ë¹„ìš© -->
        <div class="form-row">
          <!-- ì‹œ/ë„ -->
          <div class="form-group small">
            <label class="form-label">ì‹œ / ë„</label>

            {% if mode == "edit" %}
              <input type="text"
                     class="form-input"
                     name="region"
                     value="{{ recruit.region }}"
                     readonly>
            {% else %}
              <select id="sido"
                      class="form-input"
                      name="sido"
                      required>
                <option value="">ì‹œ/ë„ ì„ íƒ</option>
              </select>
            {% endif %}
          </div>

          <!-- êµ¬/êµ° -->
          <div class="form-group small">
            <label class="form-label">êµ¬ / êµ°</label>

            {% if mode == "edit" %}
              <input type="text"
                     class="form-input"
                     name="region2"
                     value="{{ recruit.region2 }}"
                     readonly>
            {% else %}
              <select id="sigungu"
                      class="form-input"
                      name="sigungu"
                      required>
                <option value="">êµ¬/êµ° ì„ íƒ</option>
              </select>
            {% endif %}
          </div>

          <!-- ì¢…ëª© -->
          <div class="form-group small">
            <label class="form-label">ì¢…ëª©</label>

            {% if mode == "edit" %}
              <input type="text"
                     class="form-input"
                     name="sport_type"
                     value="{{ recruit.sport_type }}"
                     readonly>
            {% else %}
              <input type="text"
                     class="form-input"
                     name="sport"
                     required>
            {% endif %}
          </div>

          <!-- ëª¨ì§‘ ì¸ì› -->
          <div class="form-group small">
            <label class="form-label">ëª¨ì§‘ ì¸ì›</label>

            {% if mode == "edit" %}
              <input type="number"
                     class="form-input"
                     name="num_member"
                     value="{{ recruit.num_member }}"
                     readonly>
            {% else %}
              <input type="number"
                     class="form-input"
                     name="personnel"
                     min="1"
                     required>
            {% endif %}
          </div>
        </div>
        



        <!-- 2-1. ë§ˆê°ë‚ ì§œ (ì‘ì„±/ìˆ˜ì • ëª¨ë‘ í‘œì‹œ) -->
        <div class="form-row">
          <div class="form-group small">
            <label class="form-label">ë§ˆê°ë‚ ì§œ</label>

            <div class="radio-group">

              <!-- ë§ˆê°ì¼ ì„¤ì • -->
              <label>
                <input type="radio"
                      name="end_type"
                      value="date"
                      {% if mode == "edit" %}
                          {% if not is_always_open %}checked{% endif %}
                          disabled
                      {% else %}
                          checked
                      {% endif %}>
                ë§ˆê°ì¼ ì„¤ì •
              </label>

              <!-- ìƒì‹œ ëª¨ì§‘ -->
              <label style="margin-left: 10px;">
                <input type="radio"
                      name="end_type"
                      value="always"
                      {% if mode == "edit" and is_always_open %}
                          checked
                      {% endif %}
                      {% if mode == "edit" %}disabled{% endif %}>
                ìƒì‹œ ëª¨ì§‘
              </label>
            </div>

            <!-- ë‚ ì§œ ì…ë ¥ -->
            <input type="date"
                  name="end_set_date"
                  class="form-input"
                  id="endDateInput"

                  {% if mode == "edit" %}
                        {% if not is_always_open %}
                            value="{{ end_status.end_set_date|date:'Y-m-d' }}"
                        {% endif %}
                        disabled
                  {% else %}
                        min="{{ today }}"
                        required
                  {% endif %}
            >
          </div>
        </div>


        <!-- 3. ì‹œì„¤ -->
        <div class="form-group full-row">
          <label class="form-label">ì‹œì„¤</label>
          <select name="reservation_choice"
                  id="reservation_choice"
                  class="form-input">
            <option value="">ì‹œì„¤ ì„ íƒ</option>

            {% for grp in my_reservation_slots %}
              <option value="{{ grp.reservation.reservation_id }}"
                {% if mode == "edit" and grp.reservation.reservation_id == current_reservation_id %}
                  selected
                {% endif %}>
                {{ grp.facility_name }}
                ( {{ grp.date }}
                  {% for t in grp.times %}
                    {{ t.start_time }}~{{ t.end_time }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                )
              </option>
            {% endfor %}
          </select>
        </div>



        <!-- 4. ë‚´ìš© -->
        <div class="form-group full-row">
          <label class="form-label">ë‚´ìš©</label>
          <div id="editor"></div>
          <input type="hidden" name="content" id="contentInput" required>
        </div>

        <!-- 5. ì˜¤í”ˆì¹´í†¡ URL -->
        <div class="form-group full-row">
          <label class="form-label">ì˜¤í”ˆì¹´í†¡ URL</label>

          {% if mode == "edit" %}
            <!-- update ë·°ì—ì„œëŠ” í˜„ì¬ chat_url íŒŒë¼ë¯¸í„°ë¥¼ ì•ˆ ì“°ê³  ìˆê¸´ í•˜ì§€ë§Œ,
                 ê¸°ì¡´ í…œí”Œë¦¿ê³¼ í˜¸í™˜ ìœ„í•´ name ê·¸ëŒ€ë¡œ ìœ ì§€ -->
            <input type="text"
                   class="form-input"
                   name="chat_url"
                   value="{{ recruit.chat_url }}">
          {% else %}
            <input type="text"
                   class="form-input"
                   name="openchat_url">
          {% endif %}
        </div>


        <!-- 6-1. ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ (ìˆ˜ì • ëª¨ë“œì—ì„œë§Œ) -->
        {% if mode == "edit" and existing_files %}
        <section class="attachment-section">
          <h3 class="section-title">í˜„ì¬ ì²¨ë¶€íŒŒì¼</h3>
          <ul class="attachment-list">
            {% for f in existing_files %}
              <li class="attachment-item">
                <a href="{{ MEDIA_URL }}{{ f.path }}"
                   target="_blank"
                   class="attachment-link">
                  ğŸ“ {{ f.file_name }}
                </a>
                <label class="attachment-delete">
                  <input type="checkbox"
                         name="delete_files"
                         value="{{ f.pk }}">
                  ì‚­ì œ
                </label>
              </li>
            {% endfor %}
          </ul>
        </section>
        {% endif %}

        <!-- 6-2. ì‹ ê·œ ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ -->
        <section class="attachment-upload-section">
          <label class="form-label">ì²¨ë¶€íŒŒì¼</label>
          <div class="file-upload-wrapper">
            <input type="file"
                   name="files"
                   {% if mode == "edit" %}
                     id="updateFileInput"
                   {% else %}
                     id="fileInput"
                   {% endif %}
                   class="file-input"
                   multiple>

            <label for="{% if mode == 'edit' %}updateFileInput{% else %}fileInput{% endif %}"
                   class="file-upload-btn">
              <span>ğŸ“ íŒŒì¼ ì„ íƒ</span>
            </label>

            <div class="file-list"
                 id="{% if mode == 'edit' %}updateFileList{% else %}fileList{% endif %}"></div>
          </div>
        </section>

        <!-- 7. ë²„íŠ¼ -->
        <div class="btn-row">
          <button type="submit"
                  class="btn {% if mode == 'create' %}btn-submit{% else %} btn-update {% endif %}">
            {% if mode == "edit" %}ìˆ˜ì •{% else %}ì‘ì„±{% endif %}
          </button>
          <button type="button" class="btn btn-list">ëª©ë¡</button>
        </div>

      </div>
    </form>

  </div>
</div>


{% endblock %}
{% block script3 %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const fileInput = document.querySelector('input[type="file"]');
    if (!fileInput) return;

    fileInput.addEventListener("change", function() {
        const maxSize = 2 * 1024 * 1024; // 2MB
        const files = this.files;

        for (let f of files) {
            if (f.size > maxSize) {
                alert(`"${f.name}" ì€(ëŠ”) 2MBë¥¼ ì´ˆê³¼í•˜ì—¬ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                this.value = "";  // ì„ íƒí•œ íŒŒì¼ ì „ì²´ ì´ˆê¸°í™”
                return;
            }
        }
    });

    const radios = document.querySelectorAll('input[name="end_type"]');
    const endDateInput = document.getElementById("endDateInput");

    function toggleEndDate() {
      const val = document.querySelector('input[name="end_type"]:checked').value;
      if (val === "always") {
        endDateInput.disabled = true;
        endDateInput.required =  false;
        endDateInput.value = "";
      } else {
        endDateInput.disabled = false;
        endDateInput.required =  true;
      }
    }

    radios.forEach(r => r.addEventListener("change", toggleEndDate));
    toggleEndDate();


    

});

</script>


{% endblock %}